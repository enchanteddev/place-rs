<!DOCTYPE html>
<canvas id="canvas" height="1000" width="1000"></canvas>

<script defer>
    function base64ToBytes(base64) {
        const binString = atob(base64);
        return Uint8Array.from(binString, (m) => m.codePointAt(0));
    }

    function convert_to_ws(relative_path) {
        var loc = window.location, new_uri;
        if (loc.protocol === "https:") {
            new_uri = "wss:";
        } else {
            new_uri = "ws:";
        }
        new_uri += "//" + loc.host;
        new_uri += loc.pathname + relative_path;
        return new_uri;
    }

    const canvas = document.getElementById("canvas");
    canvas.addEventListener("mousedown", function (e) {
        checkNewBox(canvas, e);
    });
    const ctx = canvas.getContext("2d");

    const ws = new WebSocket(convert_to_ws("ws"));
    ws.onopen = () => {
        console.log("connected");
    }

    ws.onmessage = (e) => {
        console.log("received message: " + e.data);
        let tokens = e.data.split(" ");
        let index = Number(tokens[0]);
        let checked = tokens[1] == 'true'
        let i = Math.floor(index / 100);
        let j = index % 100;
        console.log(tokens, index, e[0], checked, i, j);
        if (checked) {
            ctx.fillRect(10 * j, 10 * i, 10, 10);
        } else {
            ctx.fillStyle = 'white';
            ctx.fillRect(10 * j, 10 * i, 10, 10);
            ctx.fillStyle = 'black';
        }
    }


    function checkNewBox(canvas, event) {
        let rect = canvas.getBoundingClientRect();
        let x = event.clientX - rect.left;
        let y = event.clientY - rect.top;
        let index = Math.floor(x / 10) + Math.floor(y / 10) * 100
        // fetch(`/check?id=${index}`).then(load)
        ws.send(`${index}`)
    }


    async function get_data() {
        const resp = await fetch("/refresh");
        return base64ToBytes(await resp.text());
    }
    function load() {
        get_data().then((data) => {
            for (let i = 0; i < 100; i++) {
                for (let j = 0; j < 100; j++) {
                    let index = i * 100 + j;
                    let num = data[Math.floor(index / 8)];
                    if ((num >> (7 - index % 8)) & 1) {
                        ctx.fillRect(10 * j, 10 * i, 10, 10);
                    } else {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(10 * j, 10 * i, 10, 10);
                        ctx.fillStyle = 'black';
                    }
                }
            }
        });
    }
    load()
    // setInterval(load, 2000)
</script>